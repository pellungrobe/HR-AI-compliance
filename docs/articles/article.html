<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article – Guiding Questions</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/6.3.0/css/tabulator.min.css">
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
      line-height: 1.3;
    }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    a { text-decoration:none; }
    .meta {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
      white-space: pre-wrap; /* preserve Excel newlines */
    }
    #table { margin-top: 16px; }

    input[type="search"] {
      padding: 8px 10px;
      font-size: 14px;
      min-width: 260px;
    }
    .hint { color:#555; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1 id="articleTitle" style="margin:0;">Article</h1>
    <a href="../index.html">← Back to index</a>
    <input id="search" type="search" placeholder="Search in table…" />
  </div>

  <div class="hint">
    Tip: checklist items are expandable (▸) like Excel “grouped” rows.
  </div>

  <div id="requirement" class="meta">Loading requirement…</div>
  <div id="table"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/6.3.0/js/tabulator.min.js"></script>
  <script>
    // --------- IMPORTANT: JSON naming convention ----------
    // For article N, the JSON file is: ../data/artN.json
    // Example: Article 9 -> ../data/art9.json

    function getArticleNumberFromUrl() {
      // Supports both:
      //   article.html?a=9
      //   article.html?article=9
      const params = new URLSearchParams(window.location.search);
      let raw = (params.get("a") || params.get("article") || "").trim();

      if (!raw) return null;

      // Accept "09" too
      const n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n <= 0) return null;

      return n; // integer
    }

    // Cell formatter: preserve newlines + wrap like Excel
    function wrapFormatter(cell) {
      const v = cell.getValue();
      const text = (v === null || v === undefined) ? "" : String(v);
      const esc = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return `<div style="white-space:pre-wrap; line-height:1.25;">${esc}</div>`;
    }

    function stripEmptyChildren(rows){
      if (!Array.isArray(rows)) return rows;

      return rows.map(r => {
        const row = {...r};

        if (Array.isArray(row._children)) {
          row._children = stripEmptyChildren(row._children);
          if (row._children.length === 0) {
            delete row._children;
          }
        } else if (row._children == null) {
          delete row._children;
        }

        return row;
      });
    }

    async function init() {
      const articleNum = getArticleNumberFromUrl();

      if (articleNum === null) {
        document.title = "Article – Guiding Questions";
        document.getElementById("articleTitle").textContent = "Article (missing parameter)";
        document.getElementById("requirement").textContent =
          "ERROR: Missing article number in URL.\n\nUse: article.html?a=9 (or ?a=10, etc.)";
        return;
      }

      // Update page title/heading like your dedicated files
      document.title = `Article ${articleNum} – Guiding Questions`;
      document.getElementById("articleTitle").textContent = `Article ${articleNum}`;

      // EXACT naming convention you requested:
      const jsonUrl = `../data/art${articleNum}.json`;

      // Load the JSON (contains requirement + rows)
      const resp = await fetch(jsonUrl);
      if (!resp.ok) {
        document.getElementById("requirement").textContent =
          `ERROR: Cannot load ${jsonUrl} (HTTP ${resp.status})`;
        return;
      }

      const payload = await resp.json();

      // Requirement block (top, like Excel merged cell / header area)
      document.getElementById("requirement").textContent =
        payload.requirement || "(No requirement text found in JSON)";

      const cleanRows = stripEmptyChildren(payload.rows || []);

      // Build table
      const table = new Tabulator("#table", {
        data: cleanRows,
        layout: "fitColumns",
        responsiveLayout: "collapse",
        pagination: false,
        movableColumns: true,
        clipboard: true,
        placeholder: "No rows to display",

        dataTree: true,
        dataTreeChildField: "_children",
        dataTreeStartExpanded: false,

        // Keep your tree icon, but leaf rows won't have _children anymore (stripEmptyChildren)
        dataTreeElement: function(row, level){
          const data = row.getData();
          if (!Array.isArray(data?._children) || data._children.length === 0) return "";
          return "<span style='display:inline-block; width:12px;'>▸</span>";
        },

        columns: [
          {
            title: "Compliance checklist",
            field: "Compliance checklist",
            formatter: wrapFormatter,
            widthGrow: 2,
            headerSort: false,
            frozen: true
          },
          {
            title: "Guiding Questions",
            field: "Guiding Questions",
            formatter: wrapFormatter,
            widthGrow: 3,
            headerSort: false
          }
        ]
      });

      // Global search across ALL visible text fields (parents + children)
      const search = document.getElementById("search");
      search.addEventListener("input", () => {
        const q = search.value.trim().toLowerCase();
        if (!q) {
          table.clearFilter(true);
          return;
        }

        table.setFilter((rowData) => {
          const parentHit = Object.values(rowData).some(v =>
            String(v ?? "").toLowerCase().includes(q)
          );
          if (parentHit) return true;

          const kids = rowData._children || [];
          return kids.some(k =>
            Object.values(k).some(v =>
              String(v ?? "").toLowerCase().includes(q)
            )
          );
        });
      });
    }

    init().catch(err => {
      document.getElementById("requirement").textContent =
        "ERROR initializing page: " + err;
    });
  </script>
</body>
</html>
