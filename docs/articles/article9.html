<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article 09 – Guiding Questions</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/6.3.0/css/tabulator.min.css">
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
      line-height: 1.3;
    }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    a { text-decoration:none; }
    .meta {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
      white-space: pre-wrap; /* preserve Excel newlines */
    }
    #table { margin-top: 16px; }

    input[type="search"] {
      padding: 8px 10px;
      font-size: 14px;
      min-width: 260px;
    }
    .hint { color:#555; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1 style="margin:0;">Article 09</h1>
    <a href="../index.html">← Back to index</a>
    <input id="search" type="search" placeholder="Search in table…" />
  </div>

  <div class="hint">
    Tip: checklist items are expandable (▸) like Excel “grouped” rows.
  </div>

  <div id="requirement" class="meta">Loading requirement…</div>
  <div id="table"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/6.3.0/js/tabulator.min.js"></script>
  <script>
    // CHANGE THIS PER ARTICLE:
    const articleNum = "09";
    const jsonUrl = `../data/article-${articleNum}.json`;

    // Cell formatter: preserve newlines + wrap like Excel
    function wrapFormatter(cell) {
      const v = cell.getValue();
      const text = (v === null || v === undefined) ? "" : String(v);
      const esc = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return `<div style="white-space:pre-wrap; line-height:1.25;">${esc}</div>`;
    }

    async function init() {
      // Load the JSON (contains requirement + rows)
      const resp = await fetch(jsonUrl);
      if (!resp.ok) {
        document.getElementById("requirement").textContent =
          `ERROR: Cannot load ${jsonUrl} (HTTP ${resp.status})`;
        return;
      }
      const payload = await resp.json();

      // Requirement block (top, like Excel merged cell / header area)
      document.getElementById("requirement").textContent =
        payload.requirement || "(No requirement text found in JSON)";

      // Build table
      const table = new Tabulator("#table", {
        data: payload.rows || [],
        layout: "fitColumns",
        responsiveLayout: "collapse",
        pagination: true,
        paginationSize: 20,
        movableColumns: true,
        clipboard: true,
        placeholder: "No rows to display",

        // Excel-like nesting: checklist item (parent) -> guiding questions (children)
        dataTree: true,
        dataTreeChildField: "_children",
        dataTreeStartExpanded: false,

        columns: [
          {
            title: "Compliance checklist",
            field: "Compliance checklist",
            formatter: wrapFormatter,
            widthGrow: 2,
            headerSort: false,
            frozen: true
          },
          {
            title: "Guiding Questions",
            field: "Guiding Questions",
            formatter: wrapFormatter,
            widthGrow: 3,
            headerSort: false
          },
          {
            title: "In-Context",
            field: "In-Context",
            formatter: wrapFormatter,
            widthGrow: 2,
            headerSort: false
          }
        ]
      });

      // Global search across ALL visible text fields (parents + children)
      const search = document.getElementById("search");
      search.addEventListener("input", () => {
        const q = search.value.trim().toLowerCase();
        if (!q) {
          table.clearFilter(true);
          return;
        }

        table.setFilter((rowData) => {
          // check parent row fields
          const parentHit = Object.values(rowData).some(v =>
            String(v ?? "").toLowerCase().includes(q)
          );
          if (parentHit) return true;

          // check children too
          const kids = rowData._children || [];
          return kids.some(k =>
            Object.values(k).some(v =>
              String(v ?? "").toLowerCase().includes(q)
            )
          );
        });
      });
    }

    init().catch(err => {
      document.getElementById("requirement").textContent =
        "ERROR initializing page: " + err;
    });
  </script>
</body>
</html>
